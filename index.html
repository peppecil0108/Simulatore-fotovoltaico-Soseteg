e ora?
<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<title>Simulatore Fotovoltaico SOSETEG</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<style>
body { font-family: Arial, sans-serif; margin:12px; background:#fff; color:#222; }
h2 { text-align:center; color:#2e7d32; }
.step { display:none; }
.step.active { display:block; }
button { padding:12px; width:100%; margin-top:12px; cursor:pointer; background:#2e7d32; color:#fff; border:none; border-radius:6px; font-size:16px; }
button.secondary { background:#546e7a; }
label { font-weight:600; margin-top:10px; display:block; font-size:16px; }
small { font-weight:400; font-size:0.85rem; color:#555; }
input, select { padding:8px; width:100%; border-radius:4px; border:1px solid #ccc; font-size:16px; }
.box { background:#fff; border-radius:8px; padding:16px; margin-top:14px; box-shadow:0 2px 12px rgba(0,0,0,.1); }
.calc { font-size:0.9rem; background:#f1f5f9; padding:14px; border-radius:6px; line-height:1.55; }
#map { height:500px; width:100%; border-radius:8px; margin-top:8px; }
#roofWarningBox { display:none; color:#856404; background:#fff3cd; padding:8px; border-radius:4px; margin-bottom:8px; white-space: pre-line; }
</style>
</head>
<body>

<br>
<a href="https://www.soseteg.it" target="_blank" style="display: block; text-align: center;">
  <img 
    src="https://static.wixstatic.com/media/02f472_01b47059d90245dca972e74c5e32e821~mv2.webp"
    alt="Logo SOSETEG"
    style="width:130px; height:auto;"
  >
</a>

<h2>‚òÄÔ∏è Simulatore Fotovoltaico SOSETEG SPA</h2>

<!-- STEP 1 - INDIRIZZO -->
<div class="step active" id="step1">
<div class="box">
<label>Inserisci indirizzo</label>
<input id="address" placeholder="Via Roma 10, Milano">
<button onclick="goStep(2)">Continua</button>
</div>
</div>

<!-- STEP 2 - MAPPA -->
<div class="step" id="step2">
<div class="box">
<h4>Disegna il tetto</h4>
<p>üñäÔ∏è Clicca sulla mappa per tracciare i vertici del tetto. Chiudi il poligono cliccando sul primo vertice.</p>
<div id="map"></div>
<div style="margin-top:8px;">
    <button class="secondary" onclick="drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON)">‚úèÔ∏è Disegna nuovo tetto</button>
    <button class="secondary" onclick="resetRoof()">‚ôªÔ∏è Cancella tetto</button>
    <button class="secondary" onclick="confirmRoof()">‚úîÔ∏è Conferma tetto</button>
</div>
<p><b>Area:</b> <span id="roofArea">0</span> m¬≤</p>
<p><b>Zona:</b> <span id="zoneTxt">Centro</span></p>
<button onclick="safeContinue()">Continua</button>
</div>
</div>

<!-- STEP 3 - DATI CASA -->
<div class="step" id="step3">
<div class="box">
<label>Persone</label>
<input type="number" id="people" value="3">

<label>Consumo annuo (kWh, opzionale)</label>
<input type="number" id="manualCons">
<small>Se lasci vuoto, il simulatore stima il consumo in base al numero di persone.</small>

<label>Ultima bolletta (‚Ç¨)</label>
<input type="number" id="lastBill">
<small>Inserisci l'importo dell'ultima bolletta bimestrale (2 mesi)</small>

<p style="font-size:0.9rem; color:#555;">Consumo notturno stimato al 30%, inclinazione pannelli fissa 30¬∞ (ottimale).</p>

<button onclick="goStep(4)">Continua</button>
</div>
</div>

<!-- STEP 4 - IMPIANTO -->
<div class="step" id="step4">
<div class="box">
<label>Pannello (W)</label>
<select id="panelW"><option>400</option><option>450</option><option>500</option></select>

<label>Batteria (kWh)</label>
<select id="battery"><option value="0">No</option><option>5</option><option>7</option><option>10</option></select>

<button onclick="calculate()">Calcola</button>
</div>
</div>

<!-- STEP 5 - RISULTATI -->
<div class="step" id="step5">
<div class="box">
<h3>Risultato</h3>
<div id="roofWarningBox"></div>
<div>Pannelli: <b id="panels"></b></div>
<div>Potenza: <b id="kwp"></b></div>
<div>Produzione: <b id="prod"></b></div>
<div>Batterie: <b id="batt"></b></div>
<div>Risparmio: <b id="save"></b></div>
<div>Area occupata: <b id="areaUsed"></b> m¬≤</div>
<div id="batteryAlert" style="display:none; background:#f8d7da; color:#721c24; padding:12px; border-radius:6px; margin-top:10px; font-weight:600;"></div>
</div>

<div class="box">
<h4>üìå Calcoli dettagliati (passo-passo)</h4>
<div class="calc" id="calcBox"></div>
</div>

<button class="secondary" onclick="downloadPDF()">üìÑ Scarica PDF</button>
<button onclick="goStep(1)">Nuova simulazione</button>
</div>

<script>
let roof=0, zone="centro";
const ZONE_YIELD={nord:1100, centro:1250, sud:1450};
const PANEL_AREA=2; 
const BATTERY_OPTIONS = [0,5,7,10];
const NIGHT_PERCENT = 0.3; 
const PANEL_TILT = 30; 

function goStep(n){
 document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
 document.getElementById("step"+n).classList.add("active");
}

let map, drawingManager, roofPolygon = null;

function initMap(){
  map = new google.maps.Map(document.getElementById("map"),{
    zoom:18,
    center:{lat:41.9,lng:12.49},
    mapTypeId:"satellite",
    tilt:0
  });

  const ac=new google.maps.places.Autocomplete(document.getElementById("address"));
  ac.addListener("place_changed",()=>{
    const p=ac.getPlace();
    if(!p.geometry) return;
    const lat=p.geometry.location.lat();
    zone=lat>45?"nord":lat>42?"centro":"sud";
    document.getElementById("zoneTxt").innerText=zone;
    map.setCenter(p.geometry.location);
    map.setZoom(20);
  });

  drawingManager = new google.maps.drawing.DrawingManager({
    drawingMode: google.maps.drawing.OverlayType.POLYGON,
    drawingControl: false,
    polygonOptions:{
      fillColor:"#00c853",
      fillOpacity:0.35,
      strokeColor:"#2e7d32",
      strokeWeight:2,
      editable:true,
      draggable:false
    }
  });

  drawingManager.setMap(map);

  google.maps.event.addListener(drawingManager, "polygoncomplete", poly => {
    if (roofPolygon) roofPolygon.setMap(null);
    roofPolygon = poly;
    drawingManager.setDrawingMode(null);
    poly.setEditable(true);
    updateRoofArea();
    poly.getPath().addListener("set_at", updateRoofArea);
    poly.getPath().addListener("insert_at", updateRoofArea);
    poly.getPath().addListener("remove_at", updateRoofArea);
  });
}

// Consumo medio in base a numero persone
function consumoMedio(p){
 if(p<=1) return 1800;
 if(p==2) return 2700;
 if(p==3) return 3600;
 if(p==4) return 4500;
 return 4500*(1+0.15*(p-4));
}

// Calcolo azimut medio del tetto (in gradi)
function calcAzimuth(polygon){
  if(!polygon) return 180; // default Sud
  const path = polygon.getPath();
  let azTotal=0;
  let n=0;
  for(let i=0;i<path.getLength();i++){
    let p1 = path.getAt(i);
    let p2 = path.getAt((i+1)%path.getLength());
    let dx = p2.lng() - p1.lng();
    let dy = p2.lat() - p1.lat();
    let az = Math.atan2(dx, dy)*180/Math.PI;
    if(az<0) az+=360;
    azTotal+=az;
    n++;
  }
  return azTotal/n;
}

// Fattore riduzione produzione in base ad azimut
function azimuthFactor(az){
  let diff = Math.abs(az-180);
  if(diff>180) diff=360-diff;
  return Math.max(0.5, 1 - diff/180);
}

// Calcolo principale
function calculate(){
 const people = +document.getElementById("people").value;
 const manualCons = +document.getElementById("manualCons").value;
 const lastBill = +document.getElementById("lastBill").value;
 const panelW = +document.getElementById("panelW").value;
 const battSize = +document.getElementById("battery").value;

 const baseCons = manualCons || consumoMedio(people);
 const target = baseCons * 1.2;
 const panelKwp = panelW / 1000;

 const tiltFactor = Math.cos((PANEL_TILT-30)*Math.PI/180);
 const az = calcAzimuth(roofPolygon);
 const azFactor = azimuthFactor(az);

 const yieldPerKwp = ZONE_YIELD[zone]*tiltFactor*azFactor;
 const kwhPerPanel = panelKwp*yieldPerKwp;
 const maxPanelsRoof = Math.floor(roof/PANEL_AREA);
 const panelsByEnergy = Math.ceil(target/kwhPerPanel);
 const panels = Math.min(maxPanelsRoof, panelsByEnergy);

 const kwp = panels*panelKwp;
 const production = kwp*yieldPerKwp;
 const areaUsed = panels*PANEL_AREA;

 const dailyCons = baseCons/365;
 const nightCons = dailyCons*NIGHT_PERCENT;
 let battNeeded = nightCons/0.8;
 let battNum=0;
 let battCap=0;

 if(battSize>0){
   battNum = Math.ceil(battNeeded/battSize);
   battCap = battNum * battSize;
 } else {
   let suggested = BATTERY_OPTIONS.find(b=>b>=battNeeded) || 10;
   battNum = Math.ceil(battNeeded/suggested);
   battCap = battNum * suggested;
 }

 const battAlertBox = document.getElementById("batteryAlert");
 if(battSize == 0 && battNeeded > 1){
   battAlertBox.style.display = "block";
   battAlertBox.innerHTML = `‚ö†Ô∏è <b>Batteria consigliata</b><br>
   Consumo notturno stimato: <b>${nightCons.toFixed(1)} kWh</b>.<br>
   Servirebbero circa <b>${battCap} kWh</b> di accumulo per coprire la notte.`;
 } else {
   battAlertBox.style.display = "none";
 }

 let savedKwh;
 if(battSize > 0){
   savedKwh = Math.min(baseCons, production);
 } else {
   const dayPerc = 1 - NIGHT_PERCENT;
   savedKwh = Math.min(baseCons, production * dayPerc);
 }

 let euro = 0;
 if(lastBill){
   const annualBill = lastBill * 6;
   const costPerKwh = annualBill / baseCons;
   euro = savedKwh * costPerKwh;
 } else {
   euro = savedKwh * 0.30;
 }

 const invest = kwp*1600 + battCap*800;
 const roofWarning = panels<panelsByEnergy? 
   `‚ö†Ô∏è Tetto insufficiente: servirebbero ${panelsByEnergy} pannelli (${panelsByEnergy*PANEL_AREA} m¬≤), ma il tetto ne permette solo ${panels} (${areaUsed} m¬≤).` : "";
 const surplusMsg = production > baseCons ? "‚ö†Ô∏è Attenzione: la produzione supera i consumi annui. L‚Äôeccesso pu√≤ essere venduto o non utilizzato." : "";

 document.getElementById("roofWarningBox").innerText = roofWarning + (surplusMsg ? "\n" + surplusMsg : "");
 document.getElementById("panels").innerText = panels;
 document.getElementById("kwp").innerText = kwp.toFixed(2)+" kWp";
 document.getElementById("prod").innerText = Math.round(production)+" kWh";
 document.getElementById("batt").innerText = battCap+" kWh";
 document.getElementById("save").innerText = "‚Ç¨ "+Math.round(euro);
 document.getElementById("areaUsed").innerText = areaUsed;
 document.getElementById("calcBox").innerHTML = `
<em>‚ö†Ô∏è Risultati indicativi. Consultare sempre un tecnico Soseteg per preventivi reali.</em><br><br>
${roofWarning ? `<b>${roofWarning}</b><br><br>` : ""}
<b>1Ô∏è‚É£ Consumi</b><br>
‚Ä¢ Persone: ${people}<br>
‚Ä¢ Consumo base stimato: ${baseCons.toFixed(0)} kWh/anno<br>
‚Ä¢ Margine +20%: ${Math.round(target)} kWh/anno<br><br>
<b>2Ô∏è‚É£ Tetto</b><br>
‚Ä¢ Superficie totale: ${roof.toFixed(1)} m¬≤<br>
‚Ä¢ Superficie utilizzabile (80%): ${(roof*0.8).toFixed(1)} m¬≤<br>
‚Ä¢ Azimut medio tetto: ${az.toFixed(0)}¬∞<br>
‚Ä¢ Fattore azimut: ${azFactor.toFixed(2)}<br><br>
<b>3Ô∏è‚É£ Pannelli</b><br>
‚Ä¢ Area singolo pannello: ${PANEL_AREA} m¬≤<br>
‚Ä¢ Pannelli max su tetto: ${maxPanelsRoof}<br>
‚Ä¢ Produzione singolo pannello: ${panelW} W √ó yieldPerKwp = ${kwhPerPanel.toFixed(0)} kWh/anno<br>
‚Ä¢ Pannelli richiesti: ${panelsByEnergy}<br>
‚Ä¢ Pannelli installati: ${panels}<br>
‚Ä¢ Area totale occupata: ${areaUsed} m¬≤<br><br>
<b>4Ô∏è‚É£ Impianto</b><br>
‚Ä¢ Potenza totale: ${kwp.toFixed(2)} kWp<br>
‚Ä¢ Produzione annua totale: ${Math.round(production)} kWh<br><br>
<b>5Ô∏è‚É£ Accumulo</b><br>
‚Ä¢ Consumo giornaliero medio: ${dailyCons.toFixed(2)} kWh<br>
‚Ä¢ Consumo notturno stimato (30%): ${nightCons.toFixed(2)} kWh<br>
‚Ä¢ Batteria necessaria (+20% sicurezza): ${battNeeded.toFixed(2)} kWh<br>
‚Ä¢ Batterie installate: ${battSize>0? battNum : 0}<br><br>
<b>6Ô∏è‚É£ Risparmio</b><br>
‚Ä¢ Energia autoconsumata: ${Math.round(savedKwh)} kWh<br>
‚Ä¢ Risparmio annuo stimato: ‚Ç¨ ${Math.round(euro)}<br>
‚Ä¢ Investimento stimato: ‚Ç¨ ${Math.round(invest)}<br>
`;

 goStep(5);
}

function updateRoofArea(){
  if(!roofPolygon) return;
  roof = google.maps.geometry.spherical.computeArea(roofPolygon.getPath());
  if (roof > 0) { document.getElementById("roofArea").innerText = roof.toFixed(1); }
}

function confirmRoof(){
  if(!roofPolygon){ alert("Disegna prima il tetto sulla mappa"); return; }
  updateRoofArea();
  if(roof < 10){ alert("Area troppo piccola o non valida. Ridisegna il poligono."); return; }
  alert("Tetto confermato: " + roof.toFixed(1) + " m¬≤");
}

function resetRoof(){
  if(roofPolygon){ roofPolygon.setMap(null); roofPolygon = null; }
  roof = 0;
  document.getElementById("roofArea").innerText = "0";
  drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
}

function safeContinue(){
  updateRoofArea();
  if(!roofPolygon || roof < 10){ alert("Disegna e conferma prima il tetto"); return; }
  goStep(3);
}

function downloadPDF(){
  const element = document.getElementById("step5");
  const opt = {
    margin: 0.5,
    filename: 'Simulazione_Fotovoltaico_SOSETEG.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(element).save();
}
</script>

<!-- API Google Maps + html2pdf -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyByTl4pZ68bM3eKJk3kg_iD4YIc7NUL64g&libraries=places,drawing,geometry&callback=initMap" async defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

</body>
</html>
