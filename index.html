<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<title>Simulatore Fotovoltaico</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
body { font-family: Arial, Helvetica, sans-serif; margin: 12px; }
.step { display:none; }
.step.active { display:block; }
#navigation { margin:15px 0; display:flex; gap:10px; }
button { padding:8px 12px; cursor:pointer; }
#map { height:520px; width:100%; border:1px solid #ccc; }
.results { background:#f8f8f8; margin-top:10px; padding:12px; border-radius:6px; }
.controls-inline { display:flex; gap:8px; margin-top:8px; }
#formSection { background:#fff; padding:12px; border-radius:6px; border:1px solid #eee; }
label{ display:block; margin-top:8px; font-weight:600; }
select,input[type="number"],input[type="text"]{ padding:8px; width:260px; }
.small { font-size:0.9rem; color:#555; margin-top:6px; }
.output { background:#eef7ff; padding:10px; border-radius:6px; margin-top:8px; }
</style>
</head>

<body>

<h2>Simulatore Fotovoltaico — Versione Completa</h2>

<div id="navigation">
<button onclick="goStep(1)">Step 1</button>
<button onclick="goStep(2)">Step 2</button>
<button onclick="goStep(3)">Step 3</button>
</div>

<!-- STEP 1 -->
<div id="step1" class="step active">
<h3>1️⃣ Inserisci indirizzo</h3>
<input id="address" type="text" placeholder="Inserisci indirizzo..." />
<button id="btnSearch">Cerca</button>
<button onclick="goStep(2)">Continua</button>
</div>

<!-- STEP 2 -->
<div id="step2" class="step">
<h3>2️⃣ Disegna il tetto</h3>
<button id="btnClear">Resetta</button>
<div id="map"></div>

<div class="results" id="summary" style="display:none;">
<div><strong>Area tetto:</strong> <span id="areaVal">0</span> m²</div>
<div><strong>Orientamento medio:</strong> <span id="azimuthVal">—</span> °</div>
<button onclick="goStep(3)">Continua</button>
</div>

<button onclick="goStep(1)">Indietro</button>
</div>

<!-- STEP 3 -->
<div id="step3" class="step">
<h3>3️⃣ Consumi e calcolo</h3>

<div id="formSection">

<label>Tipologia pannello (W)</label>
<select id="panelW">
<option value="400">400</option>
<option value="450">450</option>
<option value="500">500</option>
</select>

<label>Numero persone</label>
<input type="number" id="people" value="2" min="1"/>

<label>Consumi</label>
<input type="radio" name="consType" value="default" checked> Default<br>
<input type="radio" name="consType" value="bill"> Ultima bolletta
<input type="number" id="lastBill" disabled><br>
<input type="radio" name="consType" value="annual"> Consumo annuo
<input type="number" id="annualKwh" disabled><br>

<button id="btnCalculate">Calcola</button>
<button onclick="goStep(2)">Indietro</button>

<div class="output" id="calcOutput" style="display:none;">
<div><strong>Potenza impianto:</strong> <span id="outKw"></span> kWp</div>
<div><strong>Pannelli installabili:</strong> <span id="outPanels"></span></div>
<div><strong>Produzione annua:</strong> <span id="outProd"></span></div>
<div><strong>Copertura consumi:</strong> <span id="outCover"></span></div>
</div>

</div>
</div>

<script>
let map, polygon, drawingManager, autocomplete;

// ================= MAPPA =================
function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 18,
        center: { lat: 41.9028, lng: 12.4964 }
    });

    autocomplete = new google.maps.places.Autocomplete(
        document.getElementById("address")
    );

    drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: google.maps.drawing.OverlayType.POLYGON,
        drawingControl: true,
        polygonOptions: {
            fillColor: "#00ff00",
            fillOpacity: 0.35,
            strokeWeight: 2,
            editable: true
        }
    });

    drawingManager.setMap(map);

    google.maps.event.addListener(drawingManager, "polygoncomplete", poly => {
        if (polygon) polygon.setMap(null);
        polygon = poly;
        updateSummary();
    });

    document.getElementById("btnClear").onclick = () => {
        if (polygon) polygon.setMap(null);
        polygon = null;
        document.getElementById("summary").style.display = "none";
    };
}

// ================= STEP =================
function goStep(n) {
    document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
    document.getElementById("step" + n).classList.add("active");
}

// ================= RIEPILOGO TETTO =================
function updateSummary() {
    const area = google.maps.geometry.spherical.computeArea(polygon.getPath());
    document.getElementById("areaVal").innerText = area.toFixed(1);

    let total = 0;
    const path = polygon.getPath().getArray();
    for (let i = 0; i < path.length - 1; i++) {
        total += google.maps.geometry.spherical.computeHeading(path[i], path[i+1]);
    }
    document.getElementById("azimuthVal").innerText = (total / path.length).toFixed(1);

    document.getElementById("summary").style.display = "block";
}

// ================= CAMPI CONSUMO =================
document.querySelectorAll('input[name="consType"]').forEach(r => {
    r.addEventListener("change", () => {
        lastBill.disabled = true;
        annualKwh.disabled = true;
        if (r.value === "bill") lastBill.disabled = false;
        if (r.value === "annual") annualKwh.disabled = false;
    });
});

// ================= CALCOLO =================
document.getElementById("btnCalculate").addEventListener("click", doCalculation);

function doCalculation() {
    if (!polygon) {
        alert("Disegna prima il tetto");
        return;
    }

    const area = google.maps.geometry.spherical.computeArea(polygon.getPath());
    const panelW = Number(panelWSelect.value || panelW.value);
    const panelArea = 1.8;
    const people = Number(document.getElementById("people").value);

    let consumption;
    const type = document.querySelector('input[name="consType"]:checked').value;

    if (type === "annual") consumption = Number(annualKwh.value);
    else if (type === "bill") consumption = Number(lastBill.value);
    else consumption = consumoMedio(people);

    const maxPanels = Math.floor(area / panelArea);
    const kwhPerPanel = (panelW / 1000) * 1200;
    const neededPanels = Math.ceil(consumption / kwhPerPanel);

    const finalPanels = Math.min(maxPanels, neededPanels);
    const kwp = (finalPanels * panelW) / 1000;
    const production = Math.round(kwp * 1200);
    const coverage = Math.min(100, Math.round((production / consumption) * 100));

    outKw.innerText = kwp.toFixed(2);
    outPanels.innerText = finalPanels;
    outProd.innerText = production + " kWh";
    outCover.innerText = coverage + "%";

    calcOutput.style.display = "block";
}

// ================= CONSUMI MEDI =================
function consumoMedio(p) {
    if (p === 1) return 1800;
    if (p === 2) return 2700;
    if (p === 3) return 3600;
    return 4500;
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyByTl4pZ68bM3eKJk3kg_iD4YIc7NUL64g&libraries=places,drawing,geometry&callback=initMap" async defer></script>

</body>
</html>
