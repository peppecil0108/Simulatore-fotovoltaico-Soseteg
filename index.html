<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<title>Simulatore Fotovoltaico ‚Äì Demo Commerciale</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
body { font-family: Arial, sans-serif; margin:12px; background:#fafafa;}
.step { display:none; }
.step.active { display:block; }
button { padding:10px; width:100%; margin-top:10px; cursor:pointer; }
label { font-weight:600; margin-top:10px; display:block; }
input, select { padding:8px; width:100%; }

.box { background:#fff; border-radius:8px; padding:14px; margin-top:12px; box-shadow:0 2px 6px rgba(0,0,0,.05); }
.box h4 { margin-top:0; }

.chart { display:flex; height:160px; gap:20px; align-items:flex-end; margin-top:10px;}
.bar { width:45%; background:#4caf50; color:#fff; text-align:center; font-weight:bold;}
.bar.winter { background:#2196f3;}

.calc { font-size:0.9rem; color:#333; background:#f3f6f9; padding:10px; border-radius:6px; margin-top:8px;}

@media(min-width:768px){
 body { max-width:760px; margin:auto; }
}
</style>
</head>

<body>

<h2>Simulatore Fotovoltaico</h2>
<p><strong>Versione demo</strong> ‚Äì calcoli visibili</p>

<!-- STEP 1 -->
<div class="step active" id="step1">
<div class="box">
<h4>1Ô∏è‚É£ Abitazione</h4>

<label>Numero persone</label>
<input type="number" id="people" value="3" min="1">

<label>Superficie tetto disponibile (m¬≤)</label>
<input type="number" id="roof" value="50">

<button onclick="goStep(2)">Continua</button>
</div>
</div>

<!-- STEP 2 -->
<div class="step" id="step2">
<div class="box">
<h4>2Ô∏è‚É£ Impianto</h4>

<label>Potenza pannello (W)</label>
<select id="panelW">
<option value="400">400</option>
<option value="450">450</option>
<option value="500">500</option>
</select>

<label>Inclinazione pannelli (¬∞)</label>
<input type="number" id="tilt" value="30">

<label>Batteria singola (kWh)</label>
<select id="battery">
<option value="5">5</option>
<option value="7">7</option>
<option value="10">10</option>
</select>

<button onclick="calculate()">Calcola</button>
</div>
</div>

<!-- STEP 3 -->
<div class="step" id="step3">

<!-- RISULTATI -->
<div class="box">
<h4>üìä Risultato impianto</h4>

<div><strong>Pannelli:</strong> <span id="panels"></span></div>
<div><strong>Potenza:</strong> <span id="kwp"></span></div>
<div><strong>Produzione annua:</strong> <span id="prod"></span></div>
<div><strong>Copertura tetto:</strong> <span id="areaPerc"></span></div>
</div>

<!-- BATTERIE -->
<div class="box">
<h4>üîã Accumulo</h4>
<div><strong>Batterie:</strong> <span id="battNum"></span></div>
<div><strong>Capacit√† totale:</strong> <span id="battCap"></span></div>
</div>

<!-- RISPARMI -->
<div class="box">
<h4>üí∞ Risparmio stimato</h4>
<div><strong>Risparmio annuo:</strong> <span id="saveEuro"></span></div>
<div><strong>Rientro investimento:</strong> <span id="payback"></span></div>

<div class="chart">
  <div class="bar">75%</div>
  <div class="bar winter">35%</div>
</div>
</div>

<!-- CALCOLI VISIBILI -->
<div class="box">
<h4>Calcoli</h4>
<div class="calc" id="calcBox"></div>
</div>

<button onclick="goStep(1)">Nuova simulazione</button>
</div>

<script>
// ===== PARAMETRI COMMERCIALI =====
const PANEL_AREA = 2; // 2 m¬≤ per pannello
const SPECIFIC_YIELD = 1200;
const ENERGY_COST = 0.30;
const COST_FV_KWP = 1600;
const COST_BATT_KWH = 800;
const SELF_CONSUMPTION = 0.55;

// ===== STEP =====
function goStep(n){
 document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
 document.getElementById('step'+n).classList.add('active');
}

// ===== CONSUMI =====
function consumoMedio(p){
 if(p<=1) return 1800;
 if(p===2) return 2700;
 if(p===3) return 3600;
 if(p===4) return 4500;
 // >4 persone: aumento 15% per ogni persona in pi√π
 return 4500 * (1 + 0.15*(p-4));
}

// ===== CALCOLO =====
function calculate(){
 const people = +peopleEl.value;
 const roof = +roofEl.value;
 const panelW = +panelWEl.value;
 const tilt = +tiltEl.value;
 const battSize = +batteryEl.value;

 const baseCons = consumoMedio(people);
 const target = baseCons * 1.2; // +20% margine

 const tiltFactor = Math.cos((tilt-30)*Math.PI/180);
 const kwhPanel = panelW/1000 * SPECIFIC_YIELD * tiltFactor;

 const maxPanels = Math.floor(roof/PANEL_AREA);
 const panels = Math.min(maxPanels, Math.ceil(target/kwhPanel));

 const kwp = panels * panelW / 1000;
 const production = kwp * SPECIFIC_YIELD * tiltFactor;

 const areaCovered = panels * PANEL_AREA;
 const areaPerc = Math.round((areaCovered / roof) * 100);

// ===== ACCUMULO FINALE - RISPETTA SCELTA UTENTE =====
const dailyConsumption = baseCons / 365;
const nightConsumption = dailyConsumption * 0.45; // consumo notturno stimato

let batteryNeeded = nightConsumption / 0.8; // fabbisogno reale

const battCapSingle = battSize;
let battNum = 1;

// aumenta solo se fabbisogno > batteria scelta + 20%
if(batteryNeeded > battCapSingle * 1.2){
    battNum = Math.ceil(batteryNeeded / battCapSingle);
}

const battCap = battNum * battCapSingle;

// ===== RISPARMI =====
const savedKwh = Math.min(baseCons, production * SELF_CONSUMPTION);
const savedEuro = savedKwh * ENERGY_COST;
const investment = kwp*COST_FV_KWP + battCap*COST_BATT_KWH;
const payback = investment / savedEuro;

// ===== OUTPUT =====
panelsEl.innerText = panels;
kwpEl.innerText = kwp.toFixed(2)+" kWp";
prodEl.innerText = Math.round(production)+" kWh";
areaPercEl.innerText = `${areaCovered} m¬≤ su ${roof} m¬≤ (${areaPerc}%)`;

battNumEl.innerText = battNum;
battCapEl.innerText = battCap+" kWh";

saveEuroEl.innerText = "‚Ç¨ "+Math.round(savedEuro)+" / anno";
paybackEl.innerText = payback.toFixed(1)+" anni";

// ===== CALCOLI VISIBILI =====
calcBox.innerHTML = `
<h4>üìå Calcoli passo passo</h4>

<b>1Ô∏è‚É£ Consumi:</b><br>
- Consumo medio stimato: <b>${baseCons.toFixed(0)} kWh/anno</b><br>
- Target con +20% margine: <b>${Math.round(target)} kWh/anno</b><br><br>

<b>2Ô∏è‚É£ Produzione pannelli:</b><br>
- Produzione per pannello: ${panelW} W √ó ${SPECIFIC_YIELD} √ó fattore inclinazione (${tiltFactor.toFixed(2)}) = <b>${kwhPanel.toFixed(0)} kWh/anno</b><br>
- Numero pannelli necessari: <b>${panels}</b><br>
- Potenza totale impianto: <b>${kwp.toFixed(2)} kWp</b><br>
- Produzione totale stimata: <b>${Math.round(production)} kWh/anno</b><br>
- Copertura tetto: <b>${areaCovered} m¬≤</b> su <b>${roof} m¬≤</b> (${areaPerc} %)<br><br>

<b>3Ô∏è‚É£ Accumulo batteria:</b><br>
- Batteria scelta: <b>${battSize} kWh</b><br>
- Fabbisogno notturno stimato: <b>${(dailyConsumption*0.45).toFixed(2)} kWh/giorno</b><br>
- Capacit√† necessaria (efficienza 80%): <b>${batteryNeeded.toFixed(2)} kWh</b><br>
- Numero batterie consigliato: <b>${battNum}</b><br>
- Capacit√† totale accumulo: <b>${battCap} kWh</b><br><br>

<b>4Ô∏è‚É£ Risparmio e payback:</b><br>
- Energia autoconsumata stimata: <b>${Math.round(savedKwh)} kWh/anno</b><br>
- Risparmio annuo in bolletta: <b>‚Ç¨ ${Math.round(savedEuro)}</b><br>
- Costo impianto FV + batterie: <b>‚Ç¨ ${Math.round(investment)}</b><br>
- Tempo stimato di rientro: <b>${payback.toFixed(1)} anni</b>
`;

goStep(3);
}

// ===== ELEMENTI =====
const peopleEl = document.getElementById("people");
const roofEl = document.getElementById("roof");
const panelWEl = document.getElementById("panelW");
const tiltEl = document.getElementById("tilt");
const batteryEl = document.getElementById("battery");

const panelsEl = document.getElementById("panels");
const kwpEl = document.getElementById("kwp");
const prodEl = document.getElementById("prod");
const areaPercEl = document.getElementById("areaPerc");
const battNumEl = document.getElementById("battNum");
const battCapEl = document.getElementById("battCap");
const saveEuroEl = document.getElementById("saveEuro");
const paybackEl = document.getElementById("payback");
const calcBox = document.getElementById("calcBox");
</script>

</body>
</html>
