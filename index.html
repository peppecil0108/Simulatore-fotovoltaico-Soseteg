<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<title>Simulatore Fotovoltaico SOSETEG</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<style>
body { font-family: Arial, sans-serif; margin:12px; background:#fff; color:#222; }
h2 { text-align:center; }
.step { display:none; }
.step.active { display:block; }
button { padding:12px; width:100%; margin-top:12px; cursor:pointer; background:#2e7d32; color:#fff; border:none; border-radius:6px; }
button.secondary { background:#546e7a; }
label { font-weight:600; margin-top:10px; display:block; }
  
input, select { padding:8px; width:100%; border-radius:4px; border:1px solid #ccc; }
input, select, textarea {
  font-size:16px;
}
  
.box { background:#fff; border-radius:8px; padding:16px; margin-top:14px; box-shadow:0 2px 8px rgba(0,0,0,.06); }
.calc { font-size:0.9rem; background:#f1f5f9; padding:14px; border-radius:6px; line-height:1.55; }
#map { height:500px; width:100%; }
#roofWarningBox { display:none; color:#856404; background:#fff3cd; padding:8px; border-radius:4px; margin-bottom:8px; }
</style>
</head>
<body>

<br>
<a href="https://www.soseteg.it" target="_blank" style="display: block; text-align: center;">
  <img 
    src="https://static.wixstatic.com/media/02f472_01b47059d90245dca972e74c5e32e821~mv2.webp"
    alt="Logo SOSETEG"
    style="width:130px; height:auto;"
  >
</a>


<h2>‚òÄÔ∏è Simulatore Fotovoltaico SOSETEG </h2>

<!-- STEP 1 - INDIRIZZO -->
<div class="step active" id="step1">
<div class="box">
<label>Inserisci indirizzo</label>
<input id="address" placeholder="Via Roma 10, Milano">
<button onclick="goStep(2)">Continua</button>
</div>
</div>

<!-- STEP 2 - MAPPA -->
<div class="step" id="step2">
<div class="box">
<h4>Disegna il tetto</h4>
<div id="map"></div>
<p><b>Area:</b> <span id="roofArea">0</span> m¬≤</p>
<p><b>Zona:</b> <span id="zoneTxt">Centro</span></p>
<button onclick="goStep(3)">Continua</button>
</div>
</div>

<!-- STEP 3 - DATI CASA -->
<div class="step" id="step3">
<div class="box">
<label>Persone</label>
<input type="number" id="people" value="3">

<label>Consumo annuo (kWh, opzionale)</label>
<input type="number" id="manualCons">

<label>Ultima bolletta (‚Ç¨)</label>
<input type="number" id="lastBill">

<label>Percentuale consumo notturno (%)</label>
<input type="number" id="nightPerc" value="45" min="0" max="100">

<button onclick="goStep(4)">Continua</button>
</div>
</div>

<!-- STEP 4 - IMPIANTO -->
<div class="step" id="step4">
<div class="box">
<label>Pannello (W)</label>
<select id="panelW"><option>400</option><option>450</option><option>500</option></select>

<label>Inclinazione pannelli (¬∞)</label>
<input type="number" id="tilt" value="30">

<label>Batteria (kWh)</label>
<select id="battery"><option value="0">No</option><option>5</option><option>7</option><option>10</option></select>

<button onclick="calculate()">Calcola</button>
</div>
</div>

<!-- STEP 5 - RISULTATI -->
<div class="step" id="step5">
<div class="box">
<h3>Risultato</h3>
<div id="roofWarningBox"></div>
<div>Pannelli: <b id="panels"></b></div>
<div>Potenza: <b id="kwp"></b></div>
<div>Produzione: <b id="prod"></b></div>
<div>Batterie: <b id="batt"></b></div>
<div>Risparmio: <b id="save"></b></div>
<div>Area occupata: <b id="areaUsed"></b> m¬≤</div>
</div>

<div class="box">
<h4>üìå Calcoli dettagliati (passo-passo)</h4>
<div class="calc" id="calcBox"></div>
</div>

<button class="secondary" onclick="window.print()">üìÑ Scarica PDF</button>
<button onclick="goStep(1)">Nuova simulazione</button>
</div>

<script>
let roof=0, zone="centro";
const ZONE_YIELD={nord:1100, centro:1250, sud:1450};
const PANEL_AREA=2; // m¬≤ per pannello
const BATTERY_OPTIONS = [0,5,7,10];

function goStep(n){
 document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
 document.getElementById("step"+n).classList.add("active");
}

// MAPPA
function initMap(){
 const map=new google.maps.Map(document.getElementById("map"),{zoom:18,center:{lat:41.9,lng:12.49}});
 const ac=new google.maps.places.Autocomplete(document.getElementById("address"));
 ac.addListener("place_changed",()=>{
   const p=ac.getPlace();
   if(!p.geometry) return;
   const lat=p.geometry.location.lat();
   zone=lat>45?"nord":lat>42?"centro":"sud";
   document.getElementById("zoneTxt").innerText=zone;
   map.setCenter(p.geometry.location);
 });
 const dm=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.POLYGON});
 dm.setMap(map);
 google.maps.event.addListener(dm,"polygoncomplete",poly=>{
   roof=google.maps.geometry.spherical.computeArea(poly.getPath());
   document.getElementById("roofArea").innerText=roof.toFixed(1);
 });
}

// CONSUMI
function consumoMedio(p){
 if(p<=1) return 1800;
 if(p==2) return 2700;
 if(p==3) return 3600;
 if(p==4) return 4500;
 return 4500*(1+0.15*(p-4));
}

// CALCOLO
function calculate(){
 const people = +document.getElementById("people").value;
 const manualCons = +document.getElementById("manualCons").value;
 const lastBill = +document.getElementById("lastBill").value;
 const nightPerc = +document.getElementById("nightPerc").value/100;
 const panelW = +document.getElementById("panelW").value;
 const tilt = +document.getElementById("tilt").value;
 const battSize = +document.getElementById("battery").value;

 const baseCons = manualCons || consumoMedio(people);
 const target = baseCons*1.2;

 const panelKwp = panelW/1000;
 const tiltFactor = Math.cos((tilt-30)*Math.PI/180);
 const yieldPerKwp = ZONE_YIELD[zone]*tiltFactor;

 const kwhPerPanel = panelKwp*yieldPerKwp;
 const maxPanelsRoof = Math.floor(roof/PANEL_AREA);
 const panelsByEnergy = Math.ceil(target/kwhPerPanel);
 const panels = Math.min(maxPanelsRoof, panelsByEnergy);

 const kwp = panels*panelKwp;
 const production = kwp*yieldPerKwp;
 const areaUsed = panels*PANEL_AREA;

 // Autoconsumo
 const dayPerc = 1-nightPerc;
 const savedKwh = Math.min(baseCons, production*dayPerc);

 // Batteria necessaria per notte (+20% sicurezza)
 const dailyCons = baseCons/365;
 const nightCons = dailyCons*nightPerc;
 let battNeeded = nightCons/0.8; // 80% utilizzabile
 let battNum=0;
 let battCap=0;

 if(battSize>0){
   battNum=Math.ceil(battNeeded/battSize);
   battCap=battNum*battSize;
 } else {
   let suggested = BATTERY_OPTIONS.find(b=>b>=battNeeded) || 10;
   battNum=Math.ceil(battNeeded/suggested);
   battCap=battNum*suggested;
 }

 const euro = lastBill ? savedKwh*(lastBill/baseCons) : savedKwh*0.30;
 const invest = kwp*1600 + battCap*800;

 // Tetto insufficiente
 const roofWarning = panels<panelsByEnergy? 
   `‚ö†Ô∏è Tetto insufficiente: servirebbero ${panelsByEnergy} pannelli (${panelsByEnergy*PANEL_AREA} m¬≤), ma il tetto ne permette solo ${panels} (${areaUsed} m¬≤).` : "";

 document.getElementById("roofWarningBox").innerText = roofWarning;
 document.getElementById("panels").innerText = panels;
 document.getElementById("kwp").innerText = kwp.toFixed(2)+" kWp";
 document.getElementById("prod").innerText = Math.round(production)+" kWh";
 document.getElementById("batt").innerText = battCap+" kWh";
 document.getElementById("save").innerText = "‚Ç¨ "+Math.round(euro);
 document.getElementById("areaUsed").innerText = areaUsed;

 // Calcoli dettagliati
 document.getElementById("calcBox").innerHTML = `
<em>‚ö†Ô∏è Attenzione: i risultati mostrati hanno valore puramente indicativo. Consultare sempre un tecnico qualificato per progettazione e preventivi reali.</em><br><br>
${roofWarning ? `<b>${roofWarning}</b><br><br>` : ""}
<b>1Ô∏è‚É£ Consumi</b><br>
‚Ä¢ Persone: ${people}<br>
‚Ä¢ Consumo base stimato: ${baseCons.toFixed(0)} kWh/anno<br>
‚Ä¢ Margine +20%: ${Math.round(target)} kWh/anno<br><br>
<b>2Ô∏è‚É£ Tetto</b><br>
‚Ä¢ Superficie totale: ${roof.toFixed(1)} m¬≤<br>
‚Ä¢ Superficie utilizzabile (80%): ${(roof*0.8).toFixed(1)} m¬≤<br><br>
<b>3Ô∏è‚É£ Pannelli</b><br>
‚Ä¢ Area singolo pannello: ${PANEL_AREA} m¬≤<br>
‚Ä¢ Pannelli max su tetto: ${maxPanelsRoof}<br>
‚Ä¢ Produzione singolo pannello: ${panelW} W √ó 1200 √ó ${tiltFactor.toFixed(2)} = ${kwhPerPanel.toFixed(0)} kWh/anno<br>
‚Ä¢ Pannelli richiesti dal fabbisogno: ${panelsByEnergy}<br>
‚Ä¢ Pannelli installati: ${panels}<br>
‚Ä¢ Area totale occupata: ${areaUsed} m¬≤<br><br>
<b>4Ô∏è‚É£ Impianto</b><br>
‚Ä¢ Potenza totale: ${kwp.toFixed(2)} kWp<br>
‚Ä¢ Produzione annua totale: ${Math.round(production)} kWh<br><br>
<b>5Ô∏è‚É£ Accumulo</b><br>
‚Ä¢ Consumo giornaliero medio: ${dailyCons.toFixed(2)} kWh<br>
‚Ä¢ Quota notturna (${(nightPerc*100).toFixed(0)}%): ${nightCons.toFixed(2)} kWh<br>
‚Ä¢ Batteria necessaria (+20% sicurezza): ${battNeeded.toFixed(2)} kWh<br>
‚Ä¢ Batteria scelta: ${battSize} kWh ${battSize===0 ? `(consigliata: ${battCap} kWh = ${battNum} unit√†)` : ""}<br>
‚Ä¢ Batterie installate: ${battSize>0? battNum : 0}<br><br>
<b>6Ô∏è‚É£ Risparmio</b><br>
‚Ä¢ Energia autoconsumata: ${Math.round(savedKwh)} kWh<br>
‚Ä¢ Risparmio annuo stimato: ‚Ç¨ ${Math.round(euro)}<br>
‚Ä¢ Investimento stimato: ‚Ç¨ ${Math.round(invest)}<br>
`;

 goStep(5);
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyByTl4pZ68bM3eKJk3kg_iD4YIc7NUL64g&libraries=places,drawing,geometry&callback=initMap" async defer></script>

</body>
</html>
